<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.w3c.spring.model.mapper.GuestReservationMapper">

    <resultMap id="memberResultMap" type="com.w3c.spring.model.vo.Member">
        <id property="memberNo" column="MEMBER_NO"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="memberPwd" column="MEMBER_PWD"/>
        <result property="memberName" column="MEMBER_NAME"/>
        <result property="memberGender" column="MEMBER_GENDER"/>
        <result property="memberRrn" column="MEMBER_RRN"/>
        <result property="memberPhone" column="MEMBER_PHONE"/>
        <result property="memberEmail" column="MEMBER_EMAIL"/>
        <result property="memberAddress" column="MEMBER_ADDRESS"/>
        <result property="memberJoinDate" column="MEMBER_JOIN_DATE"/>
        <result property="memberBloodType" column="MEMBER_BLOOD_TYPE"/>
        <result property="memberChronicDisease" column="MEMBER_CHRONIC_DISEASE"/>
        <result property="memberAllergy" column="MEMBER_ALLERGY"/>
        <result property="memberStatus" column="MEMBER_STATUS"/>
        <result property="staffNo" column="STAFF_NO"/>
    </resultMap>

    <select id="findMemberByRrn" parameterType="string" resultMap="memberResultMap">
        SELECT *
        FROM MEMBER
        WHERE MEMBER_RRN = #{rrn}
    </select>

    <select id="findMemberByPhone" parameterType="string" resultMap="memberResultMap">
        SELECT *
        FROM MEMBER
        WHERE MEMBER_PHONE = #{phone}
    </select>

    <insert id="insertGuestMember" parameterType="com.w3c.spring.model.vo.Member">
        <selectKey keyProperty="memberNo" resultType="int" order="BEFORE">
            SELECT MEMBER_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO MEMBER (
        MEMBER_NO,
        MEMBER_ID,
        MEMBER_PWD,
        MEMBER_NAME,
        MEMBER_GENDER,
        MEMBER_RRN,
        MEMBER_PHONE,
        MEMBER_EMAIL,
        MEMBER_ADDRESS,
        MEMBER_JOIN_DATE,
        MEMBER_BLOOD_TYPE,
        MEMBER_CHRONIC_DISEASE,
        MEMBER_ALLERGY,
        MEMBER_STATUS,
        STAFF_NO
        ) VALUES (
        #{memberNo},
        NULL,
        NULL,
        #{memberName},
        #{memberGender},
        #{memberRrn},
        #{memberPhone},
        #{memberEmail},
        #{memberAddress},
        SYSDATE,
        #{memberBloodType},
        #{memberChronicDisease, jdbcType=VARCHAR},
        #{memberAllergy, jdbcType=VARCHAR},
        #{memberStatus},
        NULL
        )
    </insert>

    <insert id="insertGuestGrade" parameterType="int">
        INSERT INTO GRADE (MEMBER_NO, GRADE_STATUS)
        VALUES (#{memberNo}, '일반')
    </insert>

    <select id="findDepartmentNoByName" parameterType="string" resultType="java.lang.Integer">
        SELECT DEPARTMENT_NO
        FROM DEPARTMENT
        WHERE DEPARTMENT_NAME = #{departmentName}
    </select>

    <insert id="insertGuestReservation" parameterType="com.w3c.spring.model.vo.ReservationRequestVO">
        INSERT INTO RESERVATION (
            RESERVATION_NO,
            RESERVATION_STATUS,
            RESERVATION_NOTES,
            MEMBER_NO,
            DEPARTMENT_NO,
            TREATMENT_DATE,
            RESERVATION_MEMO
        ) VALUES (
                     RESERVATION_SEQ.NEXTVAL,
                     '대기',
                     #{reservationNotes, jdbcType=VARCHAR},
                     #{memberNo},
                     #{departmentNo},
                     TO_DATE(#{treatmentDate}, 'YYYY-MM-DD HH24:MI'),
                     '비회원 예약'
                 )
    </insert>

    <select id="findGuestReservationsMap"
            resultType="java.util.HashMap">
        SELECT
            p.MEMBER_NAME      AS "patientName",
            d.DEPARTMENT_NAME  AS "departmentName",
            TO_CHAR(r.TREATMENT_DATE, 'YYYY-MM-DD') AS "treatmentDate",
            TO_CHAR(r.TREATMENT_DATE, 'HH24:MI')    AS "treatmentTime",
            r.RESERVATION_STATUS AS "status"
        FROM RESERVATION r
                 JOIN MEMBER p ON r.MEMBER_NO = p.MEMBER_NO
                 JOIN DEPARTMENT d ON r.DEPARTMENT_NO = d.DEPARTMENT_NO
        WHERE
            p.MEMBER_NAME = #{name}
          AND p.MEMBER_PHONE = #{phone}
        ORDER BY
            r.TREATMENT_DATE DESC
    </select>

</mapper>