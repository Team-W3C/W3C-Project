<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.w3c.spring.model.mapper.erp.patient.PatientMapper">
    <!-- resultMap : 조회된 resultSet의 결과를 특정 객체에 맵핑할 맵핑정보를 기술하는 것 -->
    <resultMap id="memberResultMap" type="Member">
        <id column="MEMBER_NO" property="memberNo"/>
        <result column="MEMBER_ID" property="memberId"/>
        <result column="MEMBER_PWD" property="memberPwd"/>
        <result column="MEMBER_NAME" property="memberName"/>
        <result column="MEMBER_GENDER" property="memberGender"/>
        <result column="MEMBER_RRN" property="memberRrn"/>
        <result column="MEMBER_PHONE" property="memberPhone"/>
        <result column="MEMBER_EMAIL" property="memberEmail"/>
        <result column="MEMBER_ADDRESS" property="memberAddress"/>
        <result column="MEMBER_JOIN_DATE" property="memberJoinDate"/>
        <result column="MEMBER_BLOOD_TYPE" property="memberBloodType"/>
        <result column="MEMBER_CHRONIC_DISEASE" property="memberChronicDisease"/>
        <result column="MEMBER_ALLERGY" property="memberAllergy"/>
        <result column="MEMBER_STATUS" property="memberStatus"/>
        <result column="STAFF_NO" property="staffNo"/>
    </resultMap>

    <resultMap id="patientResultMap" type="PatientListVO">
        <result column="MEMBER_NO" property="memberNo"/>
        <result column="MEMBER_NAME" property="memberName"/>
        <result column="MEMBER_GENDER" property="memberGender"/>
        <result column="MEMBER_PHONE" property="memberPhone"/>
        <result column="LAST_VISIT_DATE" property="lastVisitDate"/>
        <result column="VISIT_COUNT" property="visitCount"/>
        <result column="AGE" property="age"/>
        <result column="GRADE_STATUS" property="grade"/>
    </resultMap>

    <resultMap id="patientRecordMap" type="PatientRecordVO">
            <result column="VISIT_DATE" property="visitDate"/>
            <result column="DEPT_NAME" property="departmentName"/>
            <result column="STAFF_NAME" property="doctorName"/>
            <result column="DIAGNOSIS_NAME" property="diagnosis"/>
            <result column="RESERVATION_STATUS" property="status"/>
        </resultMap>

        <resultMap id="reservationResultMap" type="ReservationVO">
            <result column="RESERVATION_DATE" property="reservationDate"/>
            <result column="DEPT_NAME" property="departmentName"/>
            <result column="STAFF_NAME" property="doctorName"/>
            <result column="RESERVATION_TYPE" property="reservationType"/>
        </resultMap>

    <select id="selectPatientList" resultMap="patientResultMap">
        SELECT
            MEMBER_NO,
            MEMBER_NAME,
            MEMBER_GENDER,
            MEMBER_PHONE,
            MAX(V.VISIT_DATE) AS LAST_VISIT_DATE,
            COUNT(V.VISIT_DATE) AS VISIT_COUNT,
            GRADE_STATUS,
        TO_NUMBER
        (TO_CHAR(SYSDATE, 'YYYY')) - ((CASE
        WHEN SUBSTR(M.MEMBER_RRN, 8, 1) IN ('1', '2', '9', '0') THEN 1900
        ELSE 2000
        END) + TO_NUMBER(SUBSTR(M.MEMBER_RRN, 1, 2))
        )
        + 1 AS AGE
        FROM MEMBER M
        LEFT JOIN VISIT V USING (MEMBER_NO)
        LEFT JOIN GRADE G USING (MEMBER_NO)
        <where>
            M.MEMBER_STATUS = 'T'
            <if test="keyword != null and keyword != ''">
                AND (
                MEMBER_NAME LIKE '%' || #{keyword} || '%'
                OR MEMBER_NO LIKE '%' || #{keyword} || '%'
                OR MEMBER_PHONE LIKE '%' || #{keyword} || '%'
                )
            </if>
            <if test="grade != null and grade != ''">
                AND GRADE_STATUS = #{grade}
            </if>
        </where>
        GROUP BY
        MEMBER_NO, MEMBER_NAME, MEMBER_GENDER, MEMBER_PHONE, M.MEMBER_RRN, GRADE_STATUS
        ORDER BY MEMBER_NO
    </select>

    <select id="selectTotalPatientCount" resultType="_int">
        SELECT COUNT(MEMBER_NO)
        FROM MEMBER M
        WHERE M.MEMBER_STATUS = 'T'
    </select>

    <select id="selectPatientListCount" parameterType="map" resultType="_int">
        SELECT COUNT(DISTINCT MEMBER_NO)
        FROM MEMBER M
        LEFT JOIN GRADE G USING (MEMBER_NO)
        <where>
            M.MEMBER_STATUS = 'T'
            <if test="keyword != null and keyword != ''">
                AND (
                MEMBER_NAME LIKE '%' || #{keyword} || '%'
                OR MEMBER_NO LIKE '%' || #{keyword} || '%'
                OR MEMBER_PHONE LIKE '%' || #{keyword} || '%'
                )
            </if>
            <if test="grade != null and grade != ''">
                AND GRADE_STATUS = #{grade}
            </if>
        </where>
    </select>

    <!-- 오늘 방문 환자 수 -->
    <select id="selectTodayVisitCount" resultType="_int">
        SELECT COUNT(DISTINCT MEMBER_NO)
        FROM VISIT
        WHERE TRUNC(VISIT_DATE) = TRUNC(SYSDATE)
    </select>

    <!-- 이번 달 신규 환자 수 -->
    <select id="selectNewPatientCountThisMonth" resultType="_int">
        SELECT COUNT(MEMBER_NO)
        FROM MEMBER
        WHERE TO_CHAR(MEMBER_JOIN_DATE, 'YYYYMM') = TO_CHAR(SYSDATE, 'YYYYMM')
        AND MEMBER_STATUS = 'T'
    </select>

    <!-- VIP 환자 수 -->
    <select id="selectVipCount" resultType="_int">
        SELECT COUNT(MEMBER_NO)
        FROM GRADE
        WHERE GRADE_STATUS = 'VIP'
    </select>

    <insert id="insertPatient" parameterType="Member">
        INSERT INTO MEMBER (
        MEMBER_NO,
        MEMBER_NAME,         MEMBER_GENDER,       MEMBER_RRN,
        MEMBER_PHONE,        MEMBER_EMAIL,        MEMBER_ADDRESS,
        MEMBER_JOIN_DATE,    MEMBER_STATUS,
        MEMBER_CHRONIC_DISEASE
        ) VALUES (
        MEMBER_SEQ.NEXTVAL,
        #{memberId},
        #{memberPwd},
        #{memberName},
        #{memberGender},
        #{memberRrn},
        #{memberPhone},
        #{memberEmail},
        #{memberAddress},
        #{memberJoinDate},
        #{memberStatus},
        #{memberChronicDisease}
        )
    </insert>

    <select id="selectPatientDetail" resultMap="memberResultMap" parameterType="_int">
        SELECT * FROM MEMBER
        WHERE MEMBER_NO = #{memberNo}
    </select>

    <select id="selectMedicalRecords" resultMap="patientResultMap" parameterType="_int">
        SELECT
        V.VISIT_DATE,
        D.DEPARTMENT_NAME,

        <!-- [수정]
          R.STAFF_NO가 생겼으므로,
          STAFF -> MEMBER 테이블을 조인하여 의사 이름을 가져옵니다.
        -->
        S_MEM.MEMBER_NAME AS DOCTOR_NAME,

        DIAG.DIAGNOSIS_NAME,
        R.RESERVATION_STATUS AS STATUS

        FROM VISIT V

        LEFT JOIN RESERVATION R
        ON V.RESERVATION_NO = R.RESERVATION_NO
        AND R.RESERVATION_STATUS = '완료' /* '완료'된 예약만 JOIN */

        LEFT JOIN DEPARTMENT D ON R.DEPARTMENT_NO = D.DEPARTMENT_NO

        <!-- [수정] R.STAFF_NO (새 컬럼)를 사용하여 의사 이름 JOIN -->
        LEFT JOIN STAFF S ON R.STAFF_NO = S.STAFF_NO
        LEFT JOIN MEMBER S_MEM ON S.MEMBER_NO = S_MEM.MEMBER_NO

        LEFT JOIN MEDICAL_ORDER MO ON R.RESERVATION_NO = MO.RESERVATION_NO
        LEFT JOIN MEDICAL_RECORD MR ON MO.MEDICAL_RECORD_NO = MR.MEDICAL_RECORD_NO
        LEFT JOIN DIAGNOSIS DIAG ON MR.DIAGNOSIS_NO = DIAG.DIAGNOSIS_NO

        WHERE
        V.MEMBER_NO = #{memberNo}
        ORDER BY
        V.VISIT_DATE DESC
    </select>

    <select id="selectReservations" resultMap="reservationResultMap" parameterType="_int">
        SELECT
        R.TREATMENT_DATE AS RESERVATION_DATE,
        D.DEPARTMENT_NAME,

        <!-- [수정] 의사 이름 가져오기 -->
        S_MEM.MEMBER_NAME AS DOCTOR_NAME,

        R.RESERVATION_NOTES AS RESERVATION_TYPE

        FROM RESERVATION R
        LEFT JOIN DEPARTMENT D ON R.DEPARTMENT_NO = D.DEPARTMENT_NO

        <!-- [수정] R.STAFF_NO (새 컬럼)를 사용하여 의사 이름 JOIN -->
        LEFT JOIN STAFF S ON R.STAFF_NO = S.STAFF_NO
        LEFT JOIN MEMBER S_MEM ON S.MEMBER_NO = S_MEM.MEMBER_NO

        WHERE R.MEMBER_NO = #{memberNo}
        AND R.RESERVATION_STATUS = '예약' /* '예약' 상태 */
        AND R.TREATMENT_DATE >= SYSDATE
        ORDER BY
        R.TREATMENT_DATE ASC
    </select>
</mapper>