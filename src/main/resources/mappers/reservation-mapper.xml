<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.w3c.spring.model.mapper.ReservationMapper">

    <resultMap id="ReservationDetailMap" type="com.w3c.spring.model.vo.ReservationDetailVO">
        <id     property="reservationNo"   column="RESERVATION_NO" />
        <result property="status"          column="STATUS" />
        <result property="type"            column="TYPE" />
        <result property="departmentName"  column="DEPARTMENT_NAME" />
        <result property="doctorName"      column="DOCTOR_NAME" />
        <result property="date"            column="RESERVATION_DATE" />
        <result property="time"            column="RESERVATION_TIME" />
        <result property="location"        column="LOCATION" />
        <result property="age" column="AGE" />
        <result property="gender" column="GENDER" />
        <result property="symptoms" column="SYMPTOMS" />
        <result property="memo" column="MEMO" />
    </resultMap>

    <resultMap id="ReservationUpdateMap" type="com.w3c.spring.model.vo.ReservationUpdateVO">
        <id     property="reservationNo"   column="RESERVATION_NO" />
        <result property="departmentNo"    column="DEPARTMENT_NO" />
        <result property="departmentName"  column="DEPARTMENT_NAME" />
        <result property="reservationNotes" column="RESERVATION_NOTES" />
        <result property="doctorName"       column="DOCTOR_NAME" />
        <result property="treatmentDate"    column="TREATMENT_DATE" />
    </resultMap>



    <select id="findApprovedAbsences" resultType="com.w3c.spring.model.vo.AbsenceVO">
        SELECT
            absence_start_date AS absenceStartDate,
            absence_end_date AS absenceEndDate
        FROM
            ABSENCE_APPLICATION_DETAIL
        WHERE
            isApproved = 'T'
          AND absence_end_date >= TRUNC(SYSDATE)
    </select>

    <select id="findWorkingDoctorsByDeptOnDate"
            parameterType="map"
            resultType="com.w3c.spring.model.vo.WorkingDoctorVO">
        SELECT
            D.staff_no AS staffNo,
            M.member_name AS memberName,
            DEPT.department_location AS departmentLocation
        FROM
            DOCTOR D
                JOIN STAFF S ON D.staff_no = S.staff_no
                JOIN MEMBER M ON S.member_no = M.member_no
                JOIN DEPARTMENT DEPT ON D.department_no = DEPT.department_no
        WHERE
            D.department_no = #{departmentId}
          AND D.staff_no NOT IN (
            SELECT staff_no
            FROM ABSENCE_APPLICATION_DETAIL
            WHERE
                isApproved = 'T'
              AND TO_DATE(#{date}, 'YYYY-MM-DD')
                BETWEEN TRUNC(absence_start_date) AND TRUNC(absence_end_date)
        )
    </select>

    <select id="findBookedTimeCountsByDeptOnDate" parameterType="map" resultType="java.util.Map">
        SELECT
            TO_CHAR(treatment_date, 'HH24:MI') AS "HOUR",
            COUNT(*) AS "COUNT"
        FROM
            RESERVATION
        WHERE
            department_no = #{departmentId}
          AND TRUNC(treatment_date) = TO_DATE(#{date}, 'YYYY-MM-DD')
          AND reservation_status IN ('진행중', '대기')
        GROUP BY
            TO_CHAR(treatment_date, 'HH24:MI')
    </select>

    <select id="findDepartmentsWithDoctors" resultType="com.w3c.spring.model.vo.DepartmentVO">
        SELECT
            DISTINCT DEPT.department_no AS departmentNo,
                     DEPT.department_name AS departmentName,
                     DEPT.department_name AS departmentKey FROM
            DEPARTMENT DEPT
                JOIN DOCTOR D ON DEPT.department_no = D.department_no
        ORDER BY
            DEPT.department_name
    </select>

    <insert id="insertReservation" parameterType="com.w3c.spring.model.vo.ReservationRequestVO">
        INSERT INTO RESERVATION (
            reservation_no,
            reservation_status,
            reservation_notes,  reservation_memo,   member_no,
            department_no,
            treatment_date
        ) VALUES (
                     RESERVATION_SEQ.NEXTVAL,
                     '대기',
                     #{reservationNotes},
                     '담당의: ' || #{doctorName}, #{memberNo},
                     #{departmentNo},
                     TO_TIMESTAMP(#{treatmentDate}, 'YYYY-MM-DD HH24:MI')
                 )
    </insert>


    <select id="selectReservationsByMemberNo" parameterType="_int" resultMap="ReservationDetailMap">
        SELECT
            R.RESERVATION_NO        AS RESERVATION_NO,
            CASE R.RESERVATION_STATUS
                WHEN '진행중' THEN 'CONFIRMED'
                WHEN '대기' THEN 'PENDING'
                WHEN '완료' THEN 'COMPLETED'
                WHEN '취소' THEN 'CANCELLED'
                ELSE R.RESERVATION_STATUS
                END AS STATUS,
            R.RESERVATION_NOTES     AS TYPE,
            D.department_name       AS DEPARTMENT_NAME,
            R.RESERVATION_MEMO      AS DOCTOR_NAME,
            TO_CHAR(R.TREATMENT_DATE, 'YYYY-MM-DD') AS RESERVATION_DATE,
            TO_CHAR(R.TREATMENT_DATE, 'HH24:MI')    AS RESERVATION_TIME,
            D.DEPARTMENT_LOCATION   AS LOCATION
        FROM
            RESERVATION R
                LEFT JOIN
            DEPARTMENT D ON R.department_no = D.department_no
        WHERE
            R.MEMBER_NO = #{memberNo}
        ORDER BY
            R.TREATMENT_DATE DESC
    </select>

    <update id="updateReservationStatus">
        UPDATE RESERVATION
        SET
            RESERVATION_STATUS = #{status}
        WHERE
            RESERVATION_NO = #{reservationNo}
          AND MEMBER_NO = #{memberNo}
          AND RESERVATION_STATUS IN ('진행중', '대기')
    </update>

    <select id="selectReservationForUpdate" resultMap="ReservationUpdateMap" parameterType="map">
        SELECT
            R.RESERVATION_NO    AS RESERVATION_NO,
            R.DEPARTMENT_NO     AS DEPARTMENT_NO,
            D.DEPARTMENT_NAME   AS DEPARTMENT_NAME,
            R.RESERVATION_NOTES AS RESERVATION_NOTES,
            R.RESERVATION_MEMO  AS DOCTOR_NAME,
            TO_CHAR(R.TREATMENT_DATE, 'YYYY-MM-DD HH24:MI') AS TREATMENT_DATE
        FROM
            RESERVATION R
                JOIN DEPARTMENT D ON R.DEPARTMENT_NO = D.DEPARTMENT_NO
        WHERE
            R.RESERVATION_NO = #{reservationNo} 
          AND R.MEMBER_NO = #{memberNo}
          AND R.RESERVATION_STATUS IN ('진행중', '대기')
    </select>
    <update id="updateReservation" parameterType="com.w3c.spring.model.vo.ReservationRequestVO">
        UPDATE RESERVATION
        SET
            DEPARTMENT_NO = #{departmentNo},
            TREATMENT_DATE = TO_TIMESTAMP(#{treatmentDate}, 'YYYY-MM-DD HH24:MI'),
            RESERVATION_NOTES = #{reservationNotes},
            RESERVATION_MEMO = '담당의: ' || #{doctorName},
            RESERVATION_STATUS = '대기'
        WHERE
            RESERVATION_NO = #{reservationNo}
          AND MEMBER_NO = #{memberNo}
          AND RESERVATION_STATUS IN ('진행중', '대기')
    </update>

    <select id="selectReservationDetailByDate" resultMap="ReservationDetailMap">
        SELECT
            M.member_name AS patientName,
            TRUNC(
                    MONTHS_BETWEEN(
                            SYSDATE,
                            TO_DATE(
                                    CASE
                                        WHEN SUBSTR(M.member_rrn, 8, 1) IN ('1', '2') THEN '19' || SUBSTR(M.member_rrn, 1, 6)
                                        WHEN SUBSTR(M.member_rrn, 8, 1) IN ('3', '4') THEN '20' || SUBSTR(M.member_rrn, 1, 6)
                                        END,
                                    'YYYYMMDD'
                            )
                    ) / 12
            ) || '세' AS age,
            CASE M.member_gender
                WHEN 'M' THEN '남'
                WHEN 'F' THEN '여'
                END AS gender,
            R.reservation_notes AS symptoms,
            D.department_name AS department_name,
            R.reservation_status AS status,
            TO_CHAR(R.treatment_date, 'YYYY-MM-DD') AS reservationDate,
            TO_CHAR(R.treatment_date, 'HH24:MI') AS reservationTime,
            R.reservation_memo AS memo,
            R.reservation_no AS reservation_no
        FROM RESERVATION R
                 JOIN MEMBER M ON R.member_no = M.member_no
                 JOIN DEPARTMENT D ON R.department_no = D.department_no
        WHERE TRUNC(R.treatment_date) = TO_DATE(#{selectedDate},'YYYY-MM-DD')
        ORDER BY reservationDate, reservationTime
    </select>

    <update id="updateRvtnStatus" parameterType="map">
        UPDATE RESERVATION
        SET reservation_status = #{status}
        WHERE reservation_no = #{reservationNo}
    </update>

    <select id="selectRvtnDetail" resultMap="ReservationDetailMap">
        SELECT
            M.member_name AS patientName,
            'P' || TO_CHAR(M.member_no, 'FM000') AS patientCode,
            TRUNC(
                    MONTHS_BETWEEN(
                            SYSDATE,
                            TO_DATE(
                                    CASE
                                        WHEN SUBSTR(M.member_rrn, 8, 1) IN ('1', '2') THEN '19' || SUBSTR(M.member_rrn, 1, 6)
                                        WHEN SUBSTR(M.member_rrn, 8, 1) IN ('3', '4') THEN '20' || SUBSTR(M.member_rrn, 1, 6)
                                        END,
                                    'YYYYMMDD'
                            )
                    ) / 12
            ) || '세' AS age,
            CASE M.member_gender
                WHEN 'M' THEN '남'
                WHEN 'F' THEN '여'
                END AS gender,
            M.MEMBER_PHONE AS phone,
            R.RESERVATION_NO AS reservation_no,
            R.RESERVATION_NOTES AS symptoms,
            D.department_name AS DEPARTMENT_NAME,
            SUBSTR(RESERVATION_MEMO, 6, 8) AS doctor_name,
            TO_CHAR(R.TREATMENT_DATE, 'YYYY-MM-DD') AS reservationDate,
            TO_CHAR(R.TREATMENT_DATE, 'HH24:MI')    AS reservationTime
        FROM RESERVATION R
                 LEFT JOIN DEPARTMENT D ON R.department_no = D.department_no
                 LEFT JOIN MEMBER M ON R.member_no = M.member_no
        WHERE R.RESERVATION_NO = #{reservationNo}
        ORDER BY R.TREATMENT_DATE DESC
    </select>

    <select id="selectDoctorByDepartmentName" resultMap="ReservationDetailMap">
        SELECT
            DEPT.department_no AS departmentNo,
            DEPT.department_name AS departmentName,
            M.member_name AS DOCTOR_NAME
        FROM
            DEPARTMENT DEPT
                JOIN
            DOCTOR D ON DEPT.department_no = D.department_no
                JOIN
            MEMBER M ON D.staff_no = M.member_no
        WHERE
            department_name = #{departmentName}
    </select>

    <select id="findMemberNo" resultType="int">
        SELECT MEMBER_NO
        FROM MEMBER
        WHERE MEMBER_NAME = #{memberName}
    </select>

    <select id="findDepartmentNo" resultType="int">
        SELECT DEPARTMENT_NO
        FROM DEPARTMENT
        WHERE DEPARTMENT_NAME = #{departmentName}
    </select>

    <insert id="insertErpReservation">
        INSERT INTO RESERVATION (
            reservation_no,
            reservation_notes,
            member_no,
            department_no,
            treatment_date,
            reservation_memo
        ) VALUES (
                     RESERVATION_SEQ.NEXTVAL,
                     #{symptoms},
                     #{memberNo},
                     #{departmentNo},
                     TO_TIMESTAMP(#{date} || ' ' || #{time}, 'YYYY-MM-DD HH24:MI'),
                     '담당의: ' || #{memo}
                 )
    </insert>
</mapper>