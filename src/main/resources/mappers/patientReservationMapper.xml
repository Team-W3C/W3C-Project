<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.w3c.spring.model.mapper.PatientReservationMapper">
    <resultMap id="reservationResultMap" type="com.w3c.spring.model.vo.PatientReservationVO">
        <result column="reservationNo" property="reservationNo" />
        <result column="reservationTime" property="reservationTime" />
        <result column="reservationPurpose" property="reservationPurpose"/>
        <result column="reservationStatus" property="reservationStatus"/>
        <result column="patientCode" property="patientCode"/>
        <result column="patientName" property="patientName"/>
        <result column="chronicDisease" property="chronicDisease"/>
        <result column="allergy" property="allergy"/>
        <result column="gradeStatus" property="gradeStatus"/>
        <result column="departmentName" property="departmentName"/>
        <result column="treatmentWaiting" property="treatmentWaiting"/>
        <result column="treatmentOngoing" property="treatmentOngoing"/>
        <result column="treatmentComplete" property="treatmentComplete"/>
    </resultMap>

    <select id="selectTodayPatients" resultMap="reservationResultMap">
        SELECT
            R.reservation_no AS reservationNo,
            TO_CHAR(R.treatment_date, 'HH24:MI') AS reservationTime,
            R.reservation_notes AS reservationPurpose,
            R.reservation_status AS reservationStatus,
            'P' || TO_CHAR(R.patient_no, 'FM000') AS patientCode,
            R.patient_name AS patientName,
            COALESCE(PD.member_chronic_disease, '특이사항 없음') AS chronicDisease,
            PD.member_allergy AS allergy,
            PD.grade_status AS gradeStatus,
            R.department_name AS departmentName,
            PD.treatment_waiting AS treatmentWaiting,
            PD.treatment_ongoing AS treatmentOngoing,
            PD.treatment_complete AS treatmentComplete
        FROM
            V_RESERVATION_DETAILS R
                LEFT JOIN
            V_PATIENT_DETAILS PD
            ON
                R.patient_no = PD.member_no
        WHERE
            TRUNC(R.treatment_date) = TO_DATE(#{searchToday}, 'YYYYMMDD')
--           AND R.reservation_status = '확정'
        ORDER BY
            R.treatment_date ASC
    </select>


</mapper>